if(not Pen)Pen={data={}}
local function o(l,o,n,e)if#l>1and l[#l].x1==n-1and l[#l].p==o then l[#l].x2=e else add(l,{p=o,x1=n,x2=e})end end local function d(n,l,e,c,a)if l<16then o(n[1],l,e,c)elseif l==16then elseif a[l-16]<=255then o(n[2],a[l-16],e,c)else o(n[3],a[l-16],e,c)end end local c,a={0,23130,5140},{-.5,-4.5,63485.5,-261.5,62965.5,64122.5,58853.5,31322.5,42405.5,23114.5,42245.5,6666.5,1285.5,2562.5,1028.5,512.5,.5}local function w(d,o,n,e,i,f,t,r,l)if l==nil or l>=16then fillp(c[o])else fillp(a[max(flr(l),0)+1])end for l=f,r do local c=d[l+1]for o in all(c[o])do rectfill(n+o.x1,e+l,n+o.x2,e+l,o.p)end end fillp(0)end local s,x=127,127Pen.decode=function(l)if(not Pen.data[l])stop("image not found: "..tostr(l))
if(Pen.cache and Pen.cache[l])return Pen.cache[l]
local n,o=split(Pen.data[l],"\n",false),{}while(n[1]~="---")add(o,deli(n,1))
deli(n,1)local e,c={},o[1]for l=2,#c do add(e,ord(c,l)-48)end add(e,ord(c,1)-48)local c,a={},o[2]for l=1,#a,2do local l,o=ord(a,l,2)add(c,(l-48)*16+(o-48))end local r,o={},o[3]for l=1,#o,2do local l,o=ord(o,l,2)add(r,{len=l-48,p=o-48})end local f,o=nil,{}for n in all(n)do if n==""then add(o,{})elseif sub(n,1,1)=="*"then for l=1,tonum(sub(n,2))do add(o,o[#o])end else local l,e,a=0,1,{{},{},{}}while(e<=#n)local o=ord(n,e)-48if o>=128then local o=o-128d(a,o,l,l,c)l+=1e+=1elseif o>=64then local o=r[o-64+1]d(a,o.p,l,l+o.len-1,c)l+=o.len e+=1else local n=ord(n,e+1)-48d(a,n,l,l+o-1,c)l+=o e+=2end
add(o,a)f=f or l end end local o={name=l,w=f,h=#o,dpal=e,vcol=c,matrix=o}if(not Pen.cache)Pen.cache={}
Pen.cache[l]=o return o end Pen.init=function()for l,o in pairs(Pen.data)do Pen.decode(l)end end Pen.get=function(l)if type(l)=="table"then return l else return Pen.decode(l)end end Pen.crop=function(o,l,c,n,a)local o,e=Pen.get(o),{}for a=c,a do local c={}for d=1,3do local e={}for o in all(o.matrix[a+1][d])do if o.x2>=l and o.x1<=n then add(e,{x1=max(o.x1,l)-l,x2=min(o.x2,n)-l,p=o.p})end end add(c,e)end add(e,c)end return{name=o.name.." (cropped)",w=n-l+1,h=#e,dpal=o.dpal,vcol=o.vcol,matrix=e}end Pen.draw=function(l,...)local l,o,c,a=Pen.get(l),{...},peek2(24360),peek2(24362)local t,b,n=flr(o[1]or 0),flr(o[2]or 0),o[3]or{}local d,f,n,e=flr(n[1]or 0),flr(n[2]or 0),flr(n[3]or l.w-1),flr(n[4]or l.h-1)n,e=min(n,l.w-1),min(e,l.h-1)local p,r,i=o[4]or 16,t-d,b-f local u,h,s,x=max(d,c-r),max(f,a-i),min(n,c+s-r),min(e,a+x-i)if(u>=s or h>=x)return
pal(l.dpal,1)local o=o[5]or w clip(t-c,b-a,n-d+1,e-f+1)for n=1,3do o(l.matrix,n,r,i,u,h,s,x,p)end clip(0)end