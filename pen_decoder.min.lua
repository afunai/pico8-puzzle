local function o(l,o,n,e)if#l>1and l[#l].x1==n-1and l[#l].p==o then l[#l].x2=e else add(l,{p=o,x1=n,x2=e})end end local function d(n,l,e,c,a)if l<16then o(n[1],l,e,c)elseif l==16then elseif a[l-16]<=255then o(n[2],a[l-16],e,c)else o(n[3],a[l-16],e,c)end end local l={0,42405,60395}local function g(c,o,n,e,f,a,r,d)fillp(l[o])for l=a,d do local c=c[l+1]for o in all(c[o])do rectfill(n+o.x1,e+l,n+o.x2,e+l,o.p)end end fillp(0)end local x,b=127,127Pen={data={},decode=function(l)if(type(Pen.data[l])~="string")return
local n,o=split(Pen.data[l],"\n",false),{}while(n[1]~="---")add(o,deli(n,1))
deli(n,1)local e,c={},o[1]for l=1,#c do add(e,ord(c,l)-48)end local c,a={},o[2]for l=1,#a,2do local l,o=ord(a,l,2)add(c,(l-48)*16+(o-48))end local r,o={},o[3]for l=1,#o,2do local l,o=ord(o,l,2)add(r,{len=l-48,p=o-48})end local f,o=nil,{}for n in all(n)do if n==""then elseif sub(n,1,1)=="*"then for l=1,tonum(sub(n,2))do add(o,o[#o])end else local l,e,a=0,1,{{},{},{}}while(e<=#n)local o=ord(n,e)-48if o>=128then local o=o-128d(a,o,l,l,c)l+=1e+=1elseif o>=64then local o=r[o-64+1]d(a,o.p,l,l+o.len,c)l+=o.len+1e+=1else local n=ord(n,e+1)-48d(a,n,l,l+o,c)l+=o+1e+=2end
add(o,a)f=f or l end end Pen.data[l]={name=l,w=f,h=#o,dpal=e,vcol=c,matrix=o}return Pen.data[l]end,init=function()for l,o in pairs(Pen.data)do Pen.decode(l)end end,get=function(l)if type(l)=="table"then return l else local o=Pen.data[l]if(type(o)=="string")o=Pen.decode(l)
if(o==nil)stop("image not found: "..tostr(l))
return o end end,crop=function(o,l,c,n,a)local o,e=Pen.get(o),{}for a=c,a do local c={}for d=1,3do local e={}for o in all(o.matrix[a+1][d])do if o.x2>=l and o.x1<=n then add(e,{x1=max(o.x1,l)-l,x2=min(o.x2,n)-l,p=o.p})end end add(c,e)end add(e,c)end return{name=o.name.." (cropped)",w=n-l+1,h=#e,dpal=o.dpal,vcol=o.vcol,matrix=e}end,draw=function(l,...)local l,o,c,a=Pen.get(l),{...},peek2(24360),peek2(24362)local t,u,d,f,n,e=flr(o[1]or 0),flr(o[2]or 0),flr(o[3]or 0),flr(o[4]or 0),flr(o[5]or l.w-1),flr(o[6]or l.h-1)n,e=min(n,l.w-1),min(e,l.h-1)local r,i=t-d,u-f local h,s,x,b=max(d,c-r),max(f,a-i),min(n,c+x-r),min(e,a+b-i)if(h>=x or s>=b)return
for o=1,#l.dpal do pal(o-1,l.dpal[o],1)end local o=o[7]or g clip(t-c,u-a,n-d+1,e-f+1)for n=1,3do o(l.matrix,n,r,i,h,s,x,b)end clip(0)end}