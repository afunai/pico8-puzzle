if(Pen==nil)Pen={data={}}
local function i(l,o)if(l==nil)return nil
local n={}for e=1,3do if l[e]~=nil then for d=1,#l[e]do local l=l[e][d]add(n,{x1=l.x1+o,x2=l.x2+o,p=l.p})end end end for l=2,#n do local l=l while(l>1and n[l-1].x1>n[l].x1)n[l],n[l-1]=n[l-1],n[l]l=l-1
end return n end local function f(n)local l={{},{},{}}for n in all(n)do if n.p<16then add(l[1],n)elseif n.p<=255then add(l[2],n)else add(l[3],n)end end return l end Pen.composite=function(n,e,...)local l,n,e=Pen.get(n),Pen.get(e),{...}local e,d,o=e[1]or 0,e[2]or 0,{}for c=min(d,0)+1,max(d+l.h,n.h)do local l,e=i(l.matrix[c-d],max(e,0)),i(n.matrix[c],max(-e,0))if l==nil then add(o,f(e))elseif e==nil then add(o,f(l))else local d,i={},1local n=e[i]for l in all(l)do while n~=nil and n.x2<=l.x2 do if n.x1<l.x1 then add(d,{x1=n.x1,x2=min(n.x2,l.x1-1),p=n.p})end i+=1n=e[i]end add(d,l)if n~=nil then if n.x1<l.x1 then add(d,{x1=n.x1,x2=l.x1-1,p=n.p})end n.x1=max(n.x1,l.x2+1)end end while(n~=nil)add(d,n)i+=1n=e[i]
add(o,f(d))end end local d if e>=0then d=max(l.w+e,n.w)else d=max(n.w-e,l.w)end return{name=l.name.." + "..n.name,w=d,h=#o,dpal=n.dpal,vcol=n.vcol,matrix=o}end